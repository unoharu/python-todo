{% extends "base.html" %}

{% block meta %}
    <title>ダッシュボード</title>
{% endblock %}

{% block content %}
<div class="dashboard">
<div class="container mx-auto p-8">
  <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <!-- 新しい日記を書き込むフォーム -->
      <div class="mb-8">
          <h1 class="text-2xl font-bold mb-4">お帰りなさい、{{ username }}さん</h1>
          <p class="mb-4">毎日の記録を残そう</p>

          <form id="diary-form">
              <div class="mb-4">
                  <label for="title" class="block text-sm font-medium text-gray-600">タイトル:</label>
                  <input type="text" id="title" name="title" required
                         class="mt-1 p-2 w-full border border-gray-300 rounded-md">
              </div>

              <div class="mb-4">
                  <label for="comment" class="block text-sm font-medium text-gray-600">本文:</label>
                  <textarea id="comment" name="comment" rows="4" required
                            class="mt-1 p-2 w-full border border-gray-300 rounded-md"></textarea>
              </div>

              <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">作成</button>
              <p id="form-error" class="text-red-600 mt-2 hidden"></p>
          </form>
      </div>

      <!-- 日記の一覧表示 -->
      <div>
          <h2 class="text-2xl font-bold mb-4">あなたの日記</h2>
          <ul id="diaries-list" class="list-disc pl-4">
          </ul>
      </div>
  </div>
</div>
</div>

<script>
  $(document).ready(function() {
    function showDiaries() {
        $.ajax({
            url: "/get_json",
            type: "GET",
            success: function(response) {
                $("#diaries-list").empty();
                // SQL の ORDER BY DESC で既に新しい順になっているのでそのまま表示
                response.diaries.forEach(function(diary) {
                    var diaryItem = '<li class="mb-2">' +
                        '<span class="font-semibold">' + $('<span>').text(diary.created_at).html() + '</span>' +
                        '<h3 class="text-lg font-medium">' + $('<span>').text(diary.title).html() + '</h3>' +
                        '<p>' + $('<span>').text(diary.comment).html() + '</p>' +
                        '</li>';
                    $("#diaries-list").append(diaryItem);
                });
            },
            error: function() {
                console.log("日記の取得に失敗しました。");
            }
        });
    }

    showDiaries();

    $("#diary-form").submit(function(event) {
        event.preventDefault();
        var formData = $(this).serialize();

        $.ajax({
            url: "/create_diary",
            type: "POST",
            data: formData,
            success: function() {
                $("#diary-form")[0].reset();
                $("#form-error").addClass("hidden").text("");
                showDiaries();
            },
            error: function(xhr) {
                var msg = xhr.responseJSON && xhr.responseJSON.error
                    ? xhr.responseJSON.error
                    : "日記の作成に失敗しました。";
                $("#form-error").removeClass("hidden").text(msg);
            }
        });
    });
  });
</script>

{% endblock %}

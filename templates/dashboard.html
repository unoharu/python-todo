{% extends "base.html" %}
{% block title %}ノート — Nota{% endblock %}

{% block content %}
<div style="max-width:960px;margin:0 auto;padding:40px 24px 80px;">

    <!-- ページヘッダー -->
    <div style="margin-bottom:36px;">
        <p style="font-size:0.72rem;font-weight:500;letter-spacing:0.12em;color:var(--color-indigo);text-transform:uppercase;margin-bottom:8px;">
            Welcome back
        </p>
        <h1 style="font-family:var(--font-serif);font-size:1.8rem;font-weight:700;color:var(--color-ink);letter-spacing:-0.02em;">
            {{ username }}のノート
        </h1>
    </div>

    <!-- 2カラムレイアウト -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:32px;align-items:start;">

        <!-- 左：投稿フォーム -->
        <div class="note-card" style="padding:28px 28px 28px 48px;">
            <h2 style="font-family:var(--font-serif);font-size:1rem;font-weight:700;color:var(--color-ink);margin-bottom:20px;">
                新しいページ
            </h2>
            <form id="diary-form">
                <div style="margin-bottom:16px;">
                    <label for="title" class="form-label">タイトル</label>
                    <input type="text" id="title" name="title"
                           class="form-input" placeholder="今日のできごと">
                </div>
                <div style="margin-bottom:20px;">
                    <label for="comment" class="form-label">本文</label>
                    <textarea id="comment" name="comment" rows="6"
                              class="form-input" placeholder="自由に書いてみよう..."
                              style="resize:vertical;min-height:120px;"></textarea>
                </div>
                <div style="display:flex;align-items:center;gap:12px;">
                    <button type="submit" class="btn-primary">書き留める</button>
                    <p id="form-error" style="font-size:0.825rem;color:var(--color-rose);display:none;"></p>
                </div>
            </form>
        </div>

        <!-- 右：日記一覧 -->
        <div>
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
                <h2 style="font-family:var(--font-serif);font-size:1rem;font-weight:700;color:var(--color-ink);">
                    これまでの記録
                </h2>
                <span id="diary-count" style="font-size:0.75rem;color:var(--color-muted);"></span>
            </div>

            <div class="note-card" style="overflow:hidden;">
                <div id="diaries-list" style="padding:0;">
                    <!-- JS で描画 -->
                </div>
                <div id="empty-state" style="padding:40px 24px;text-align:center;display:none;">
                    <p style="font-size:0.875rem;color:var(--color-muted);line-height:1.7;">
                        まだ記録がありません。<br>左のフォームから書きはじめましょう。
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 編集モーダル -->
<div id="edit-modal" class="modal-overlay" style="display:none;">
    <div class="modal-box">
        <h3 style="font-family:var(--font-serif);font-size:1.1rem;font-weight:700;color:var(--color-ink);margin-bottom:20px;">
            ページを編集
        </h3>
        <form id="edit-form">
            <input type="hidden" id="edit-diary-id">
            <div style="margin-bottom:16px;">
                <label for="edit-title" class="form-label">タイトル</label>
                <input type="text" id="edit-title" name="title" class="form-input">
            </div>
            <div style="margin-bottom:20px;">
                <label for="edit-comment" class="form-label">本文</label>
                <textarea id="edit-comment" name="comment" rows="5"
                          class="form-input" style="resize:vertical;min-height:100px;"></textarea>
            </div>
            <p id="edit-error" style="font-size:0.825rem;color:var(--color-rose);margin-bottom:12px;display:none;"></p>
            <div style="display:flex;gap:10px;justify-content:flex-end;">
                <button type="button" id="edit-cancel" class="btn-ghost">キャンセル</button>
                <button type="submit" class="btn-primary">保存する</button>
            </div>
        </form>
    </div>
</div>

<script>
$(function () {

    /* ---- 日記一覧の描画 ---- */
    function renderDiaries(diaries) {
        var $list = $('#diaries-list').empty();

        if (diaries.length === 0) {
            $('#empty-state').show();
            $('#diary-count').text('');
            return;
        }

        $('#empty-state').hide();
        $('#diary-count').text(diaries.length + ' ページ');

        diaries.forEach(function (d, i) {
            var safeTitle   = $('<span>').text(d.title).html();
            var safeComment = $('<span>').text(d.comment).html();
            var safeDate    = $('<span>').text(d.created_at).html();

            var $card = $('<div class="diary-card" style="animation-delay:' + (i * 0.04) + 's">').html(
                '<div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;">' +
                    '<div style="flex:1;min-width:0;">' +
                        '<p class="date-badge" style="margin-bottom:4px;">' + safeDate + '</p>' +
                        '<h3 style="font-family:var(--font-serif);font-size:0.95rem;font-weight:700;color:var(--color-ink);margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + safeTitle + '</h3>' +
                        '<p style="font-size:0.825rem;color:var(--color-muted);line-height:1.6;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">' + safeComment + '</p>' +
                    '</div>' +
                    '<div style="display:flex;gap:4px;flex-shrink:0;">' +
                        '<button class="btn-ghost edit-btn" data-id="' + d.id + '" data-title="' + safeTitle + '" data-comment="' + $('<span>').text(d.comment).html() + '" style="font-size:0.72rem;padding:4px 10px;">編集</button>' +
                        '<button class="btn-danger delete-btn" data-id="' + d.id + '" title="削除">✕</button>' +
                    '</div>' +
                '</div>'
            );
            $list.append($card);
        });
    }

    /* ---- 一覧取得 ---- */
    function loadDiaries() {
        $.get('/get_json', function (resp) {
            renderDiaries(resp.diaries);
        });
    }

    loadDiaries();

    /* ---- 新規作成 ---- */
    $('#diary-form').on('submit', function (e) {
        e.preventDefault();
        var $btn = $(this).find('button[type=submit]');
        $btn.prop('disabled', true);

        $.ajax({
            url: '/create_diary',
            type: 'POST',
            data: $(this).serialize(),
            success: function () {
                $('#diary-form')[0].reset();
                $('#form-error').hide().text('');
                loadDiaries();
            },
            error: function (xhr) {
                var msg = xhr.responseJSON && xhr.responseJSON.error
                    ? xhr.responseJSON.error : '作成に失敗しました。';
                $('#form-error').text(msg).show();
                $('#diary-form').addClass('shake');
                setTimeout(function () { $('#diary-form').removeClass('shake'); }, 400);
            },
            complete: function () { $btn.prop('disabled', false); }
        });
    });

    /* ---- 削除 ---- */
    $(document).on('click', '.delete-btn', function () {
        var id = $(this).data('id');
        var $card = $(this).closest('.diary-card');

        if (!confirm('このページを削除しますか？')) return;

        $.ajax({
            url: '/diary/' + id + '/delete',
            type: 'POST',
            success: function () { loadDiaries(); },
            error: function () { alert('削除できませんでした。'); }
        });
    });

    /* ---- 編集モーダル：開く ---- */
    $(document).on('click', '.edit-btn', function () {
        var $btn = $(this);
        $('#edit-diary-id').val($btn.data('id'));
        $('#edit-title').val($('<div>').html($btn.data('title')).text());
        $('#edit-comment').val($('<div>').html($btn.data('comment')).text());
        $('#edit-error').hide().text('');
        $('#edit-modal').css('display', 'flex');
    });

    /* ---- 編集モーダル：閉じる ---- */
    $('#edit-cancel').on('click', function () { $('#edit-modal').hide(); });
    $('#edit-modal').on('click', function (e) {
        if (e.target === this) $(this).hide();
    });

    /* ---- 編集フォーム送信 ---- */
    $('#edit-form').on('submit', function (e) {
        e.preventDefault();
        var id = $('#edit-diary-id').val();
        var $btn = $(this).find('button[type=submit]');
        $btn.prop('disabled', true);

        $.ajax({
            url: '/diary/' + id + '/update',
            type: 'POST',
            data: { title: $('#edit-title').val(), comment: $('#edit-comment').val() },
            success: function () {
                $('#edit-modal').hide();
                loadDiaries();
            },
            error: function (xhr) {
                var msg = xhr.responseJSON && xhr.responseJSON.error
                    ? xhr.responseJSON.error : '更新に失敗しました。';
                $('#edit-error').text(msg).show();
            },
            complete: function () { $btn.prop('disabled', false); }
        });
    });

});
</script>
{% endblock %}

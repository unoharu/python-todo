{% extends "base.html" %}
{% block title %}ノート — Nota{% endblock %}

{% block content %}
<div class="container" style="padding-top:40px;padding-bottom:80px;">

    <!-- ページヘッダー -->
    <div class="page-header">
        <p class="page-eyebrow">Welcome back</p>
        <h1 class="page-title">{{ username }}のノート</h1>
    </div>

    <!-- 2カラムレイアウト -->
    <div class="dashboard-grid">

        <!-- 左：投稿フォーム -->
        <div class="note-card">
            <div class="note-card-body">
                <h2 style="font-family:var(--font-serif);font-size:1rem;font-weight:700;color:var(--ink);margin-bottom:20px;">
                    新しいページ
                </h2>
                <form id="diary-form">
                    <div class="form-group">
                        <label for="title" class="form-label">タイトル</label>
                        <input type="text" id="title" name="title"
                               class="form-input" placeholder="今日のできごと">
                    </div>
                    <div class="form-group" style="margin-bottom:20px;">
                        <label for="comment" class="form-label">本文</label>
                        <textarea id="comment" name="comment" rows="6"
                                  class="form-input" placeholder="自由に書いてみよう..."
                                  style="resize:vertical;min-height:140px;"></textarea>
                    </div>
                    <div style="display:flex;align-items:center;gap:12px;">
                        <button type="submit" class="btn-primary">書き留める</button>
                        <p id="form-error" style="font-size:0.82rem;color:var(--rose);display:none;"></p>
                    </div>
                </form>
            </div>
        </div>

        <!-- 右：日記一覧 -->
        <div>
            <div class="list-header">
                <h2 class="list-title">これまでの記録</h2>
                <span id="diary-count" class="list-count" style="display:none;"></span>
            </div>

            <div class="note-card" style="overflow:hidden;">
                <div id="diaries-list"></div>
                <div id="empty-state" class="empty-state" style="display:none;">
                    <p class="empty-state-text">
                        まだ記録がありません。<br>左のフォームから書きはじめましょう。
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 編集モーダル -->
<div id="edit-modal" class="modal-overlay" style="display:none;">
    <div class="modal-box">
        <h3 class="modal-title">ページを編集</h3>
        <form id="edit-form">
            <input type="hidden" id="edit-diary-id">
            <div class="form-group">
                <label for="edit-title" class="form-label">タイトル</label>
                <input type="text" id="edit-title" name="title" class="form-input">
            </div>
            <div class="form-group" style="margin-bottom:20px;">
                <label for="edit-comment" class="form-label">本文</label>
                <textarea id="edit-comment" name="comment" rows="5"
                          class="form-input" style="resize:vertical;min-height:100px;"></textarea>
            </div>
            <p id="edit-error" style="font-size:0.82rem;color:var(--rose);margin-bottom:12px;display:none;"></p>
            <div style="display:flex;gap:10px;justify-content:flex-end;">
                <button type="button" id="edit-cancel" class="btn-secondary">キャンセル</button>
                <button type="submit" class="btn-primary">保存する</button>
            </div>
        </form>
    </div>
</div>

<script>
$(function () {

    /* ---- 日記一覧の描画 ---- */
    function renderDiaries(diaries) {
        var $list = $('#diaries-list').empty();

        if (diaries.length === 0) {
            $('#empty-state').show();
            $('#diary-count').hide();
            return;
        }

        $('#empty-state').hide();
        $('#diary-count').text(diaries.length).show();

        diaries.forEach(function (d, i) {
            var safeTitle   = $('<span>').text(d.title).html();
            var safeComment = $('<span>').text(d.comment).html();
            var safeDate    = $('<span>').text(d.created_at).html();
            var safeRawComment = $('<span>').text(d.comment).html();

            var $card = $('<div class="diary-card">').css('animation-delay', (i * 0.04) + 's').html(
                '<div class="diary-card-header">' +
                    '<div class="diary-card-body">' +
                        '<p class="date-badge">' + safeDate + '</p>' +
                        '<h3 class="diary-title">' + safeTitle + '</h3>' +
                        '<p class="diary-preview">' + safeComment + '</p>' +
                    '</div>' +
                    '<div class="diary-card-actions">' +
                        '<button class="btn-edit edit-btn" data-id="' + d.id + '" data-title="' + safeTitle + '" data-comment="' + safeRawComment + '">編集</button>' +
                        '<button class="btn-delete delete-btn" data-id="' + d.id + '" title="削除">✕</button>' +
                    '</div>' +
                '</div>'
            );
            $list.append($card);
        });
    }

    /* ---- 一覧取得 ---- */
    function loadDiaries() {
        $.get('/get_json', function (resp) {
            renderDiaries(resp.diaries);
        });
    }

    loadDiaries();

    /* ---- 新規作成 ---- */
    $('#diary-form').on('submit', function (e) {
        e.preventDefault();
        var $btn = $(this).find('button[type=submit]');
        $btn.prop('disabled', true);

        $.ajax({
            url: '/create_diary',
            type: 'POST',
            data: $(this).serialize(),
            success: function () {
                $('#diary-form')[0].reset();
                $('#form-error').hide().text('');
                loadDiaries();
            },
            error: function (xhr) {
                var msg = xhr.responseJSON && xhr.responseJSON.error
                    ? xhr.responseJSON.error : '作成に失敗しました。';
                $('#form-error').text(msg).show();
                $('#diary-form').addClass('shake');
                setTimeout(function () { $('#diary-form').removeClass('shake'); }, 400);
            },
            complete: function () { $btn.prop('disabled', false); }
        });
    });

    /* ---- 削除 ---- */
    $(document).on('click', '.delete-btn', function () {
        var id = $(this).data('id');

        if (!confirm('このページを削除しますか？')) return;

        $.ajax({
            url: '/diary/' + id + '/delete',
            type: 'POST',
            success: function () { loadDiaries(); },
            error: function () { alert('削除できませんでした。'); }
        });
    });

    /* ---- 編集モーダル：開く ---- */
    $(document).on('click', '.edit-btn', function () {
        var $btn = $(this);
        $('#edit-diary-id').val($btn.data('id'));
        $('#edit-title').val($('<div>').html($btn.data('title')).text());
        $('#edit-comment').val($('<div>').html($btn.data('comment')).text());
        $('#edit-error').hide().text('');
        $('#edit-modal').css('display', 'flex');
    });

    /* ---- 編集モーダル：閉じる ---- */
    $('#edit-cancel').on('click', function () { $('#edit-modal').hide(); });
    $('#edit-modal').on('click', function (e) {
        if (e.target === this) $(this).hide();
    });

    /* ---- 編集フォーム送信 ---- */
    $('#edit-form').on('submit', function (e) {
        e.preventDefault();
        var id = $('#edit-diary-id').val();
        var $btn = $(this).find('button[type=submit]');
        $btn.prop('disabled', true);

        $.ajax({
            url: '/diary/' + id + '/update',
            type: 'POST',
            data: { title: $('#edit-title').val(), comment: $('#edit-comment').val() },
            success: function () {
                $('#edit-modal').hide();
                loadDiaries();
            },
            error: function (xhr) {
                var msg = xhr.responseJSON && xhr.responseJSON.error
                    ? xhr.responseJSON.error : '更新に失敗しました。';
                $('#edit-error').text(msg).show();
            },
            complete: function () { $btn.prop('disabled', false); }
        });
    });

});
</script>
{% endblock %}
